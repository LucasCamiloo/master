<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos Listados</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
        --primary-color: #662d91;
        --primary-light: #8347af;
        --primary-dark: #4a1d6e;
        --primary-transparent: rgba(102, 45, 145, 0.1);
        --secondary-color: #8347af;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --dark-bg: #1a1a1a;
        --light-bg: #f8f9fa;
        --border-radius: 8px;
        --spacing-sm: 0.5rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
    }
        .product-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            padding: 0;
        }

        .product-item {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 1px solid var(--primary-transparent);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: auto;
            min-height: 350px;
        }

        .product-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(102, 45, 145, 0.15);
        }

        .product-item img {
            width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: 0.5rem;
        }

        .product-item h3, .product-item p, .product-item .fw-bold {
            width: 100%;
            text-align: center;
        }

        .product-item h3 {
            font-size: 1rem;
            margin: 0.5rem 0;
        }

        .product-item p {
            flex: 1;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .product-item .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 0.5rem;
        }

        .product-item .btn {
            flex: 1;
        }

        @media (max-width: 768px) {
            .product-container {
                grid-template-columns: 1fr;
            }
        }

        .navbar {
            background-color: var(--primary-color) !important;
        }

        main {
            background-color: var(--light-bg);
            padding: 1rem;
            min-height: auto;
        }

        .container-fluid {
            padding: 1rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border-radius: var(--border-radius);
        }

        h2 {
            color: var(--primary-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
            border-color: var(--primary-light);
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem var(--primary-transparent);
        }

        /* Modal customization */
        .modal-header {
            background-color: var(--primary-color);
            color: white;
        }

        .modal-title {
            color: white;
        }

        /* Adicionar background apenas para cards de conteúdo */
        .content-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px rgba(102, 45, 145, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style>
    <script src="script.js" defer></script>
</head>
<body>

<!-- BARRA DE NAVEGAÇÃO BOOTSTRAP -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    
        <a class="navbar-brand" href="#">
            <img src="/LOGO_DYP.png" alt="Logo DYP" height="30">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" 
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" 
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" href="/">
                        <i class="bi bi-house"></i> Home
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/anuncios">
                        <i class="bi bi-image"></i> Anúncios
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-box"></i> Produtos
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item" href="/produtos/adicionarProd">
                                <i class="bi bi-plus-circle"></i> Adicionar Produto
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="/produtos/product-list">
                                <i class="bi bi-list"></i> Lista de Produtos
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
   
  </nav>




    <!-- Página de Produtos Listados -->

    <main>
        <div class="container-fluid">
            <div class="content-card">
                <h2 class="mb-4 text-center">Confira os produtos disponíveis:</h2>
                
                <!-- Search bar -->
                <div class="mb-4">
                    <input type="text" id="productSearchInput" class="form-control" 
                           placeholder="Pesquisar produtos por nome ou descrição...">
                </div>
            </div>
            
            <!-- Product container -->
            <div class="content-card">
                <div id="product-container" class="product-container">
                    <!-- Os produtos serão adicionados aqui -->
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Edição -->
    <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProductModalLabel">Editar Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-product-form">
                        <input type="hidden" id="edit-product-index">
                        <div class="form-group mb-3">
                            <label for="edit-product-name">Nome do Produto:</label>
                            <input type="text" id="edit-product-name" class="form-control" required>
                        </div>
                        <div class="form-group mb-3">
                            <label for="edit-product-description">Descrição do Produto:</label>
                            <textarea id="edit-product-description" class="form-control" rows="5" required></textarea>
                        </div>
                        <div class="form-group mb-3">
                            <label for="edit-product-price">Preço do Produto:</label>
                            <input type="text" id="edit-product-price" class="form-control" required>
                        </div>
                        <div class="form-group mb-3">
                            <label for="imageLink">Link da Imagem:</label>
                            <input type="text" id="imageLink" placeholder="https://exemplo.com/imagem.jpg">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="save-changes-btn" onclick="saveProductChanges()">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update the script section to remove localStorage references -->
    <script>
        const MASTER_URL = 'https://master-teste.vercel.app';

        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            document.getElementById('productSearchInput').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterProducts(searchTerm);
            });
        });

        async function loadProducts() {
            try {
                const response = await fetch(`${MASTER_URL}/api/products`);
                if (!response.ok) throw new Error('Failed to load products');
                const data = await response.json();
                const container = document.getElementById('product-container');
                container.innerHTML = '';
                
                if (!data.success || !data.products || data.products.length === 0) {
                    container.innerHTML = '<div class="text-center"><p>Nenhum produto adicionado.</p></div>';
                    return;
                }

                data.products.forEach(product => {
                    const productElement = document.createElement('div');
                    productElement.className = 'product-item';
                    productElement.dataset.name = product.name.toLowerCase();
                    productElement.dataset.description = product.description.toLowerCase();

                    const imageUrl = product.imageUrl || `${MASTER_URL}/files/default-product`;
                    console.log('Processing product:', { name: product.name, imageUrl });

                    productElement.innerHTML = `
                        <img src="${imageUrl}" 
                             alt="${product.name}" 
                             onerror="this.src='${MASTER_URL}/files/default-product';"
                             class="product-image">
                        <h3>${product.name}</h3>
                        <p>${product.description}</p>
                        <p class="fw-bold">${product.price}</p>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="editProduct('${product.id}')">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                            <button class="btn btn-danger" onclick="deleteProduct('${product.id}')">
                                <i class="bi bi-trash"></i> Excluir
                            </button>
                        </div>
                    `;

                    container.appendChild(productElement);
                });
            } catch (error) {
                console.error('Error loading products:', error);
                const container = document.getElementById('product-container');
                if (container) {
                    container.innerHTML = '<div class="text-center text-danger"><p>Erro ao carregar produtos</p></div>';
                }
            }
        }

        function filterProducts(searchTerm) {
            const products = document.querySelectorAll('.product-item');
            products.forEach(product => {
                const name = product.dataset.name;
                const description = product.dataset.description;
                const shouldShow = name.includes(searchTerm) || description.includes(searchTerm);
                product.style.display = shouldShow ? '' : 'none';
            });
        }

        async function editProduct(productId) {
            try {
                const response = await fetch(`${MASTER_URL}/api/products/${productId}`);
                if (!response.ok) {
                    throw new Error('Failed to load product');
                }

                const data = await response.json();
                if (data.success) {
                    const product = data.product;

                    document.getElementById('edit-product-index').value = productId;
                    document.getElementById('edit-product-name').value = product.name;
                    document.getElementById('edit-product-description').value = product.description;
                    document.getElementById('edit-product-price').value = product.price;
                    document.getElementById('imageLink').value = product.imageUrl;

                    const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error loading product:', error);
                alert('Erro ao carregar produto: ' + error.message);
            }
        }

        async function saveProductChanges() {
            try {
                const productId = document.getElementById('edit-product-index').value;
                const name = document.getElementById('edit-product-name').value;
                const description = document.getElementById('edit-product-description').value;
                const price = document.getElementById('edit-product-price').value;
                const imageUrl = document.getElementById('imageLink').value;

                const response = await fetch(`${MASTER_URL}/api/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        price,
                        imageUrl
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to save product changes');
                }

                const data = await response.json();
                if (data.success) {
                    // Close modal and refresh product list
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
                    modal.hide();
                    loadProducts();
                }
            } catch (error) {
                console.error('Error saving product changes:', error);
                alert('Error saving changes: ' + error.message);
            }
        }

        async function deleteProduct(productId) {
            try {
                const response = await fetch(`${MASTER_URL}/api/products/${productId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete product');
                }

                loadProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Erro ao excluir produto: ' + error.message);
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>

